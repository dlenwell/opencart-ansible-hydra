map  $http_host $storeCode  {
  com.magento.dev store_dot_com;
  de.magento.dev store_dot_de;
}

server {
  listen 8080 default;
  server_name com.magento.dev
              de.magento.dev;

  root /vagrant/data_store/magento;

  index                 index.php;
  charset               utf-8;
  access_log            /var/log/nginx/$server_name.access.log;
  fastcgi_read_timeout  3600;

  #######################################################################
  # Allow a static html file to be shown first
  # If missing pass the URI to Magento's front handler
  # Assume all files are cachable
  #
  location / {
    rewrite   ^/robots.txt$ /robots.php;
    index     index.html index.php;
    try_files $uri $uri/ @handler;
    expires   epoch;
  }

  #######################################################################
  # don't fallback to PHP inside static folders
  #
  location ~ ^/(banner|sitemaps|feeds) {
    try_files $uri $uri =404;
  }

  #######################################################################
  # when handling static images, css or js, drop cookie-header and set
  # caching to one year
  #
  location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    fastcgi_hide_header Set-Cookie;
    add_header          Cache-Control: public;
    access_log          off;
    expires             1y;
  }

  #######################################################################
  # for webfonts enable access-control-header and caching to 1 year
  #
  location ~* \.(eot|ttf|otf|woff|svg)$ {
    fastcgi_hide_header Set-Cookie;
    add_header          Cache-Control: public;
    add_header          Access-Control-Allow-Origin *;
    expires             1y;
  }

  #######################################################################
  # disallow internal folders
  #
  location /app/                { deny all; }
  location /includes/           { deny all; }
  location /lib/                { deny all; }
  location /media/downloadable/ { deny all; }
  location /pkginfo/            { deny all; }
  location /shell/              { deny all; }
  location /var/                { deny all; }
  location /var/downloads       { allow all; }

  #######################################################################
  # Disable .htaccess and other hidden files
  #
  location  /. { return 404; }

  #######################################################################
  # Magento uses a common front handler
  #
  location @handler { rewrite / /index.php; }

  #######################################################################
  # Forward paths like /js/index.php/x.js to relevant handler
  #
  location ~ \.php/ { rewrite ^(.*\.php)/ $1 last; }

  #######################################################################
  # Execute PHP scripts
  #
  location ~ \.php$ {
    expires       off; ## Do not cache dynamic content
    fastcgi_param MAGENTO_STORE   $storeCode;
    fastcgi_param MAGENTO_LANG    $storeLang;
    include includes.d/proxy_php.include;
  }
}
